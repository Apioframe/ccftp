<html>
    <head>
        <title>YesVNC</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="/gui">
        <script src="/guijs"></script>
    </head>
    <body style="font-family: lato;background-color: #36393F;">
        <div style="position: absolute; top: 50%; left: 50%; width: 50%; transform: translate(-50%, -50%); opacity: 0.8; background-color: #f4f4f4;">
            <div style="background-color: #0072c6; color: #fff; padding: 20px;">
              <div class="header">Welcome at YesVNC!</div>
              <p>We really excited to see you!</p>
            </div>
            <div id="cont" style="padding: 30px; background-color: #f4f4f4;text-align: center;">
                
            </div>
        </div>
        <script src="/socio"></script>
        <script>
            function generateString(len) {
                let out = ""
                //every lowercase character, number, uppercase character
                let chars = "abcdefghijklmnopqrstuvwxyz1234567890ABCDEFGHIJKLMNOPQRSTUVWXYZ"
                for (let i = 0; i < len; i++) {
                    out += chars[Math.floor(Math.random() * chars.length)]
                }
                return out
            }

            var LID = generateString(32)
            let vdi = window.location.search.replace("?id=","")
            if (vdi != undefined && vdi != "") {
                LID = vdi
            }

            let cont = document.getElementById('cont');
            function def() {
                cont.innerHTML = `
                On a cc/oc computer run:<br>
                <input class="ui input" disabled="disabled" value="yesvnc.lua ws://${window.location.hostname}:1011 ${LID}"></input><br>
                `
            }
            def()
            let can
            let context
            function scr() {
                cont.innerHTML = `
                <canvas id="can" style="outline: black 3px solid;"></canvas>
                `
                can = document.getElementById('can')
                context = can.getContext('2d')
            }

            let sock = new Socio("ws://" + window.location.hostname + ":1011")
            sock.emit("subscribe", "all", LID)
            sock.on("connected", function(type, id) {
                toast("Connected", "Connected (non encrypted) to #" + id + " (" + type + ")")
                scr()
            })
            sock.on("disconnected", function() {
                toast("Disconnected", "The computer disconnected")
                def()
            })

            let storage = {}
            let colorTable = {
                1: "white",
                2: "orange",
                4: "magenta",
                8: "lightblue",
                16: "yellow",
                32: "lime",
                64: "pink",
                128: "gray",
                256: "lightgray",
                512: "cyan",
                1024: "purple",
                2048: "blue",
                4096: "brown",
                8192: "green",
                16384: "red",
                32768: "black"
            }

            function clr() {
                context.fillStyle = "black"
                context.font = "13px sans-serif"
                context.fillRect(0,0,can.width,can.height)
            }

            sock.on("screen", function(dat) {
                ////TODO: capture packets and send them to the client and then with a for loop render it out
                //TODO: create a list of the columns with the last writen char (if the last is closer to 0 then use the laster one)
                //And then clear that part on write
                if (dat.length == undefined || dat == undefined) {
                    return
                }
                for (let i = 0; i < dat.length; i++) {
                    let evnt = dat[i][0]
                    let args = dat[i]
                    args.splice(0,1)

                    //cc Compatibility
                    if (evnt == "resize") {
                        can.style.width = args[0] * 13 + "px"
                        can.style.height = args[1] * 13 + "px"
                        can.width = args[0] * 13
                        can.height = args[1] * 13
                        
                        clr()
                    }
                    if (evnt == "setTextColor" || evnt == "setTextColour") {
                        context.fillStyle = colorTable[args[0]]
                    }
                    if (evnt == "setBackgroundColor" || evnt == "setBackgroundColour") {
                        storage.bg = colorTable[args[0]]
                    }
                    if (evnt == "setCursorPos") {
                        storage.x = args[0] * 13
                        storage.y = args[1] * 13
                    }
                    if (evnt == "write") {
                        let wh = context.measureText(args[0])
                        let he = 13 * 1.5

                        let sto = context.fillStyle
                        context.fillStyle = storage.bg
                        context.fillRect(storage.x,storage.y-13,wh.width,he)

                        context.fillStyle = sto
                        context.fillText(args[0],storage.x,storage.y)
                        storage.x = storage.x + wh.width
                    }
                    if (evnt == "clearLine") {
                        let sto = context.fillStyle
                        context.fillStyle = storage.bg
                        //let h = context.measureText("a")
                        let he = 13 * 1.5
                        context.fillRect(0,storage.y,can.width,he)
                        context.fillStyle = sto
                    }
                    if (evnt == "clear") {
                        clr()
                    }
                    if (evnt == "scroll") {
                        let sto = context.fillStyle
                        context.fillStyle = storage.bg
                        let img = context.getImageData(0,13,can.width,can.height/* - storage.scroll*/)
                        context.fillRect(0,0,can.width,can.height)

                        context.putImageData(img, 0, 0)
                        context.fillRect(0,can.height-13,can.width,can.height)
                        context.fillStyle = sto
                    }
                }
            })
        </script>
    </body>
</html>